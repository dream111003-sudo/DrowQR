<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Lets.抽選！</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{--accent1:#ff7a7a;--accent2:#ffd6a5;}
    html,body{height:100%;margin:0;font-family:'Noto Sans JP',sans-serif;background:linear-gradient(120deg,#ffecd2,#fcb69f);}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:32px;}
    .card{width:100%;max-width:920px;background:rgba(255,255,255,0.98);border-radius:18px;padding:28px;box-shadow:0 12px 30px rgba(0,0,0,0.12);position:relative;overflow:hidden;}
    h1{margin:0;font-size:30px;color:#333;}
    #status{margin-top:12px;font-weight:700;color:#555;}
    #actionArea{margin-top:18px;}
    button.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));border:0;padding:14px 22px;border-radius:12px;font-size:18px;color:#fff;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,0.12);}
    #winnerBox{display:none;margin-top:18px;padding:14px;border-radius:12px;background:linear-gradient(90deg,#fff7f7,#fffef7);box-shadow:inset 0 1px 0 rgba(255,255,255,0.6);}
    #winnerName{font-size:22px;color:#d6336c;font-weight:700;}
    #prizeName{font-size:20px;color:#333;margin-top:6px;}
    #finalList{display:none;margin-top:18px;text-align:left;}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{padding:8px;border-bottom:1px dashed #eee;}
    .small{font-size:13px;color:#666;}
    canvas.confetti{position:absolute;left:0;top:0;pointer-events:none;width:100%;height:100%;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <canvas id="confetti-canvas" class="confetti"></canvas>
      <h1>Lets.抽選！</h1>

      <div id="status">現在: <span id="currentText">--</span> / <span id="maxText">--</span>　（残り: <span id="remainingText">--</span>）</div>

      <div id="actionArea">
        <button id="drawBtn" class="primary">抽選する</button>
      </div>

      <div id="winnerBox">
        <div id="winnerName"></div>
        <div id="prizeName"></div>
        <div class="small" id="timeInfo"></div>
      </div>

      <div id="finalList">
        <button id="showListBtn" class="primary" style="background:linear-gradient(90deg,#7bdcb5,#61c0ff);">🎉 これまでの当選結果を表示</button>
        <div id="listArea"></div>
        <div style="margin-top:10px;">
          <button id="downloadPdfBtn" class="primary" style="background:linear-gradient(90deg,#ffd06b,#ff7a7a);">PDFで保存</button>
        </div>
      </div>
    </div>
  </div>

  <audio id="bgm" src="bgm.mp3" preload="auto"></audio>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

  <script>
    // === ここをあなたの GAS デプロイURL に書き換えてください ===
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzRRmfJhWZJYTg7J2bUBCuDqirX3s3aBnArzZ1gi5teXH7ORqh7WzwTVXlsyRuxrorw/exec';

    // query param
    const url = new URL(location.href);
    const pid = url.searchParams.get('pid'); // P001など

    // elements
    const drawBtn = document.getElementById('drawBtn');
    const winnerBox = document.getElementById('winnerBox');
    const winnerName = document.getElementById('winnerName');
    const prizeName = document.getElementById('prizeName');
    const timeInfo = document.getElementById('timeInfo');
    const remainingText = document.getElementById('remainingText');
    const currentText = document.getElementById('currentText');
    const maxText = document.getElementById('maxText');
    const finalList = document.getElementById('finalList');
    const showListBtn = document.getElementById('showListBtn');
    const listArea = document.getElementById('listArea');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const bgm = document.getElementById('bgm');

    // confetti
    const confettiCanvas = document.getElementById('confetti-canvas');
    const myConfetti = confetti.create(confettiCanvas, { resize: true });

    // helper: fetch status and populate top status
    async function fetchStatus(){
      try {
        const res = await fetch(`${GAS_URL}?action=status`);
        const j = await res.json();
        if(j.result === 'ok'){
          remainingText.textContent = j.remaining;
          currentText.textContent = j.currentWinners;
          maxText.textContent = j.maxWinners;
          if(j.remaining === 0){
            showFinalControls();
          }
        }
      } catch(err){
        console.warn('status fetch error', err);
      }
    }

    function showFinalControls(){
      finalList.style.display = 'block';
      drawBtn.disabled = true;
      drawBtn.textContent = '抽選は終了しました';
    }

    // 抽選実行
    async function doDraw(){
      if(!pid){
        alert('参加者ID (pid) が URL にありません。管理者は手動で pid を付けてください。');
        return;
      }
      drawBtn.disabled = true;
      drawBtn.textContent = '抽選中...';

      try {
        const res = await fetch(`${GAS_URL}?pid=${encodeURIComponent(pid)}`);
        const j = await res.json();

        // 更新されるステータスを表示
        if(j.currentWinners !== undefined){
          currentText.textContent = j.currentWinners;
          maxText.textContent = j.maxWinners;
          remainingText.textContent = j.remaining;
        }

        if(j.result === 'win'){
          // play BGM (user click context)
          try { bgm.currentTime = 0; await bgm.play(); } catch(e){ console.warn('BGM play blocked', e); }
          // confetti
          myConfetti({ particleCount: 160, spread: 90, origin: { y: 0.6 } });
          winnerBox.style.display = 'block';
          winnerName.textContent = (j.name && j.name !== '') ? j.name : '匿名';
          prizeName.textContent = '🎁 ' + j.prize;
          timeInfo.textContent = 'あなたは ' + j.currentWinners + ' 人目の当選者です';
          document.getElementById('actionArea').style.display = 'none';
          // if last winner, show finalList controls
          if(j.remaining === 0){
            finalList.style.display = 'block';
          }
        } else if(j.result === 'limit_reached'){
          alert('抽選上限に達しています。');
          showFinalControls();
        } else if(j.result === 'already_won'){
          winnerBox.style.display = 'block';
          winnerName.textContent = (j.name && j.name !== '') ? j.name : '匿名';
          prizeName.textContent = '（既に当選済み） ' + (j.prize||'');
          document.getElementById('actionArea').style.display = 'none';
        } else {
          alert('抽選でエラーが発生しました: ' + (j.message || JSON.stringify(j)));
          drawBtn.disabled = false;
          drawBtn.textContent = '抽選する';
        }
      } catch(err){
        console.error('draw error', err);
        alert('通信エラーが発生しました。');
        drawBtn.disabled = false;
        drawBtn.textContent = '抽選する';
      }
    }

    // 当選者一覧取得
    async function showWinnersList(){
      try {
        const res = await fetch(`${GAS_URL}?action=list`);
        const j = await res.json();
        if(j.result === 'ok'){
          const winners = j.winners;
          if(winners.length === 0){
            listArea.innerHTML = '<p class="small">まだ当選者はいません。</p>';
            return;
          }
          let html = '<table><thead><tr><th>No</th><th>ID</th><th>氏名</th><th>景品</th><th>当選日時</th></tr></thead><tbody>';
          for(let i=0;i<winners.length;i++){
            const w = winners[i];
            html += `<tr><td>${i+1}</td><td>${w.id}</td><td>${w.name||'匿名'}</td><td>${w.prize}</td><td>${w.time||''}</td></tr>`;
          }
          html += '</tbody></table>';
          listArea.innerHTML = html;
        }
      } catch(e){
        console.error(e);
        alert('一覧取得エラー');
      }
    }

    // PDFダウンロード（新タブでGASの ?action=pdf を開く）
    function downloadPdf(){
      window.open(`${GAS_URL}?action=pdf`, '_blank');
    }

    // イベントバインド & 初期化
    (function init(){
      fetchStatus();
      drawBtn.addEventListener('click', doDraw);
      showListBtn.addEventListener('click', showWinnersList);
      downloadPdfBtn.addEventListener('click', downloadPdf);

      // pid がない場合、抽選ボタンは残すが、押すと警告が出ます（管理者向け）
      if(!pid){
        console.warn('URLに pid パラメータがありません。例: index.html?pid=P001');
      }
    })();
  </script>
</body>
</html>
