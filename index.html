<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æŠ½é¸ãƒšãƒ¼ã‚¸ ğŸ‰</title>
<link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet" />
<style>
  /* ãƒãƒƒãƒ—ãªã‚«ãƒ©ãƒ•ãƒ«ã‚°ãƒ©ãƒ‡èƒŒæ™¯ */
  @keyframes bg-gradient {
    0% {background-position:0% 50%;}
    50% {background-position:100% 50%;}
    100% {background-position:0% 50%;}
  }
  body {
    margin:0; padding:0;
    height: 100vh;
    font-family: 'Kosugi Maru', sans-serif;
    background: linear-gradient(-45deg, #ff9a9e, #fad0c4, #fad0c4, #ff9a9e);
    background-size: 400% 400%;
    animation: bg-gradient 15s ease infinite;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    color: #333;
    text-align: center;
    user-select: none;
  }
  h1 {
    font-size: 2.4rem;
    margin-bottom: 1rem;
  }
  #message {
    font-size: 1.8rem;
    margin-bottom: 1.5rem;
    min-height: 2.5rem;
  }
  button {
    font-size: 1.4rem;
    padding: 12px 32px;
    border: none;
    border-radius: 40px;
    background: #ff7f50;
    color: white;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(255,127,80,0.6);
    transition: background 0.3s ease;
  }
  button:hover {
    background: #ff5722;
  }
  #info {
    position: fixed;
    bottom: 12px;
    right: 12px;
    background: rgba(255 255 255 / 0.8);
    padding: 8px 12px;
    border-radius: 12px;
    font-size: 0.9rem;
    color: #444;
    max-width: 200px;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
  }
  #confetti-canvas {
    position: fixed;
    pointer-events: none;
    top:0; left:0; width:100%; height:100%;
    z-index: 1000;
  }
  #winner-list-container {
    margin-top: 2rem;
    max-width: 90vw;
    max-height: 50vh;
    overflow-y: auto;
    background: rgba(255 255 255 / 0.9);
    border-radius: 12px;
    padding: 12px 16px;
    box-shadow: 0 0 16px rgba(0,0,0,0.2);
  }
  table {
    border-collapse: collapse;
    width: 100%;
    font-size: 1.1rem;
  }
  th, td {
    border: 2px solid #ff7f50;
    padding: 6px 12px;
    text-align: center;
    color: #333;
  }
  th {
    background: #ff7f50;
    color: white;
  }
  #show-winners-btn {
    margin-top: 1rem;
    background: #4caf50;
  }
</style>
</head>
<body>

<h1>ğŸ‰ ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦æŠ½é¸ï¼ ğŸ‰</h1>
<div id="message">å‚åŠ è€…IDã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚</div>
<button id="draw-btn" disabled>æŠ½é¸ã™ã‚‹</button>

<div id="info"></div>

<div id="winner-list-container" style="display:none;">
  <h2>ğŸ‰ ã“ã‚Œã¾ã§ã®å½“é¸çµæœ ğŸ</h2>
  <table id="winner-table">
    <thead>
      <tr><th>å‚åŠ è€…ID</th><th>æ°å</th><th>æ™¯å“å</th><th>å½“é¸æ—¥æ™‚</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<button id="show-winners-btn" style="display:none;">å½“é¸è€…ä¸€è¦§ã‚’è¡¨ç¤º</button>

<audio id="bgm" src="bgm.mp3" preload="auto"></audio>

<canvas id="confetti-canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<script>
  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰pidã‚’å–å¾—
  function getParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }

  const pid = getParam("pid");
  const drawBtn = document.getElementById("draw-btn");
  const message = document.getElementById("message");
  const info = document.getElementById("info");
  const bgm = document.getElementById("bgm");
  const confettiCanvas = document.getElementById("confetti-canvas");
  const winnerListContainer = document.getElementById("winner-list-container");
  const winnerTableBody = document.querySelector("#winner-table tbody");
  const showWinnersBtn = document.getElementById("show-winners-btn");

  // GASã®URLï¼ˆè¦ã”è‡ªèº«ã®GASãƒ‡ãƒ—ãƒ­ã‚¤URLã«å·®ã—æ›¿ãˆã¦ãã ã•ã„ï¼‰
  const GAS_URL = "https://script.google.com/macros/s/AKfycbz60sf6e_yGgsZCr_cJbtWsqnWWbW66oIs7n0B96guCfoTwT0Sv5GZAODnNr9J3_3PT/exec";

  let currentWinners = 0;
  let prizeCount = 0;
  let hasDrawn = false;

  if (!pid) {
    message.textContent = "ã‚¨ãƒ©ãƒ¼ï¼šå‚åŠ è€…IDï¼ˆpidï¼‰ãŒURLã«ã‚ã‚Šã¾ã›ã‚“ã€‚";
  } else {
    message.textContent = `å‚åŠ è€…ID: ${pid} ã•ã‚“ã€æº–å‚™OKã§ã™ï¼`;
    drawBtn.disabled = false;
  }

  drawBtn.addEventListener("click", () => {
    if (hasDrawn) return;
    hasDrawn = true;
    drawBtn.disabled = true;
    message.textContent = "æŠ½é¸ä¸­ãƒ»ãƒ»ãƒ»";

    fetch(`${GAS_URL}?pid=${encodeURIComponent(pid)}`)
      .then(res => res.json())
      .then(data => {
        if(data.result === "limit_reached") {
          message.textContent = "ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€ã™ã§ã«å½“é¸ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚";
          drawBtn.style.display = "none";
          showWinnersBtn.style.display = "inline-block";
          return;
        }
        if(data.result === "error") {
          message.textContent = `ã‚¨ãƒ©ãƒ¼: ${data.message}`;
          drawBtn.disabled = false;
          hasDrawn = false;
          return;
        }
        if(data.result === "already_won" || data.result === "win") {
          currentWinners = data.current_winners;
          prizeCount = data.prize_count;
          message.innerHTML = `
            ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼<br>
            <strong>${data.participant_name}</strong> ã•ã‚“ã®å½“é¸æ™¯å“ã¯<br>
            <span style="font-size:1.5rem; color:#ff5722;">${data.prize}</span> ã§ã™ï¼
          `;
          drawBtn.style.display = "none";
          playBGM();
          launchConfetti();
          updateInfo(currentWinners, prizeCount);
          if(currentWinners >= prizeCount) {
            showWinnersBtn.style.display = "inline-block";
          }
          return;
        }
        // ãã‚Œä»¥å¤–
        message.textContent = "ä¸æ˜ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡ã—ã¾ã—ãŸã€‚";
        drawBtn.disabled = false;
        hasDrawn = false;
      })
      .catch(err => {
        message.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
        drawBtn.disabled = false;
        hasDrawn = false;
        console.error(err);
      });
  });

  function updateInfo(current, total) {
    info.textContent = `å½“é¸è€…æ•°: ${current} / ${total}  æ®‹ã‚Šæ™¯å“: ${total - current}`;
  }

  function playBGM() {
    bgm.currentTime = 0;
    bgm.play().catch(e => {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ãªãƒ–ãƒ©ã‚¦ã‚¶å¯¾ç­–
      console.log("BGMå†ç”Ÿå¤±æ•—", e);
    });
  }

  function launchConfetti() {
    const duration = 5 * 1000;
    const animationEnd = Date.now() + duration;
    const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1000 };

    function frame() {
      confetti({
        particleCount: 5,
        origin: { x: Math.random(), y: Math.random() * 0.6 },
        ...defaults
      });
      if (Date.now() < animationEnd) {
        requestAnimationFrame(frame);
      }
    }
    frame();
  }

  // å½“é¸è€…ä¸€è¦§è¡¨ç¤ºå‡¦ç†
  showWinnersBtn.addEventListener("click", () => {
    showWinnersBtn.disabled = true;
    message.textContent = "å½“é¸è€…ä¸€è¦§ã‚’å–å¾—ä¸­ãƒ»ãƒ»ãƒ»";

    fetch(`${GAS_URL}?action=getWinners`)
      .then(res => res.json())
      .then(data => {
        if(data.result !== "ok") {
          message.textContent = "å½“é¸è€…ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
          showWinnersBtn.disabled = false;
          return;
        }
        message.textContent = "ã“ã‚Œã¾ã§ã®å½“é¸çµæœã‚’è¡¨ç¤ºã—ã¾ã™ã€‚";
        winnerTableBody.innerHTML = "";
        data.winners.forEach(w => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${w.id}</td>
            <td>${w.name || "åŒ¿å"}</td>
            <td>${w.prize}</td>
            <td>${new Date(w.datetime).toLocaleString()}</td>
          `;
          winnerTableBody.appendChild(tr);
        });
        winnerListContainer.style.display = "block";
        showWinnersBtn.style.display = "none";
      })
      .catch(e => {
        message.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ã§å½“é¸è€…ä¸€è¦§ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚";
        showWinnersBtn.disabled = false;
        console.error(e);
      });
  });
</script>
</body>
</html>
