<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Lets.抽選！</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    font-family: 'M PLUS Rounded 1c', sans-serif;
    background: linear-gradient(135deg, #ffecd2, #fcb69f);
    text-align: center;
    padding: 20px;
  }
  h1 { font-size: 2.5em; margin-bottom: 10px; }
  #status { font-size: 1.2em; margin: 15px 0; }
  button {
    font-size: 1.5em;
    padding: 15px 30px;
    background: #ff6f61;
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
  }
  button:hover { background: #ff3b2e; }
  #result { margin-top: 20px; font-size: 1.5em; }
  table { border-collapse: collapse; margin: 0 auto; }
  table, th, td { border: 1px solid #aaa; padding: 8px; }
</style>
</head>
<body>
<h1>Lets.抽選！</h1>
<div id="status"></div>
<button id="drawButton">抽選スタート！</button>
<div id="result"></div>
<div id="winnersList"></div>

<audio id="bgm" src="bgm.mp3"></audio>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<script>
const gasUrl = "https://script.google.com/macros/s/AKfycbz60sf6e_yGgsZCr_cJbtWsqnWWbW66oIs7n0B96guCfoTwT0Sv5GZAODnNr9J3_3PT/exec"; // GASのURL
const pid = new URLSearchParams(window.location.search).get('pid');
const statusDiv = document.getElementById("status");
const drawButton = document.getElementById("drawButton");
const resultDiv = document.getElementById("result");
const winnersListDiv = document.getElementById("winnersList");
const bgm = document.getElementById("bgm");

function updateCount() {
  fetch(`${gasUrl}?getcount=1`)
    .then(res => res.json())
    .then(data => {
      if (data.result === "count") {
        statusDiv.textContent = `現在 ${data.current} 人 / 上限 ${data.limit} 人`;
      }
    });
}
updateCount();

drawButton.addEventListener("click", () => {
  if (!pid) {
    alert("参加者IDが見つかりません");
    return;
  }
  fetch(`${gasUrl}?pid=${pid}`)
    .then(res => res.json())
    .then(data => {
      if (data.result === "limit_reached") {
        resultDiv.innerHTML = "<p>抽選は終了しました！</p>";
        drawButton.style.display = "none";
      } else if (data.result === "win") {
        updateCount();
        bgm.play();
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        resultDiv.innerHTML = `<p>🎉 ${data.name} さんが <strong>${data.prize}</strong> に当選！</p>`;
        drawButton.style.display = "none";
        if (data.current === data.limit) {
          const btn = document.createElement("button");
          btn.textContent = "当選者一覧を見る";
          btn.onclick = () => {
            fetch(`${gasUrl}?getpdf=1`)
              .then(r => r.json())
              .then(pdfData => {
                if (pdfData.result === "pdf_ready") {
                  window.open(pdfData.url, "_blank");
                }
              });
          };
          winnersListDiv.appendChild(btn);
        }
      }
    })
    .catch(err => {
      console.error(err);
      resultDiv.textContent = "エラーが発生しました。";
    });
});
</script>
</body>
</html>
