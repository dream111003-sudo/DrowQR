<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ãƒãƒƒãƒ—ãªæŠ½é¸ãƒšãƒ¼ã‚¸</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#ff9a9e; --bg2:#fad0c4;
    }
    html,body{height:100%;margin:0;font-family:'Noto Sans JP',sans-serif;}
    body{
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      display:flex;align-items:center;justify-content:center;
    }
    .card{
      width:92%; max-width:900px; background:rgba(255,255,255,0.95);
      border-radius:18px; padding:28px; box-shadow:0 10px 30px rgba(0,0,0,0.15);
      text-align:center; position:relative; overflow:hidden;
    }
    h1{margin:0 0 6px 0; font-size:28px;}
    p.lead{margin:0 0 18px 0; color:#555;}
    #status{margin:8px 0 16px 0;font-weight:700;}
    button{
      background:linear-gradient(90deg,#ff7a7a,#ffb199); border:0; padding:14px 22px;
      border-radius:12px; font-size:18px; cursor:pointer; box-shadow:0 6px 14px rgba(0,0,0,0.12);
    }
    #winnerBox{display:none; margin-top:20px;}
    #winnerName{font-size:22px; font-weight:700; color:#d6336c;}
    #prizeName{font-size:20px; color:#333;}
    #finalList{display:none; margin-top:20px; text-align:left;}
    table{width:100%; border-collapse:collapse; margin-top:10px;}
    th,td{padding:8px;border-bottom:1px dashed #ddd;}
    .small{font-size:13px;color:#666;}
    .confetti-canvas{position:absolute;left:0;top:0;pointer-events:none;width:100%;height:100%;}
  </style>
</head>
<body>
  <div class="card">
    <canvas id="confetti-canvas" class="confetti-canvas"></canvas>
    <h1>ğŸ¯ ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦æŠ½é¸ï¼</h1>
    <p class="lead">QRã§æ¥ãŸã‚‰è‡ªåˆ†ã®IDã§ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã¾ã™ã€‚æ™¯å“æ•°ãƒ»å½“é¸ä¸Šé™ã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ç®¡ç†ã€‚</p>

    <div id="status">
      <span id="remainingText">æ®‹ã‚Š: --</span>ã€€|ã€€ç¾åœ¨: <span id="currentText">--</span> / <span id="maxText">--</span>
    </div>

    <div id="actionArea">
      <button id="drawBtn">æŠ½é¸ã™ã‚‹</button>
    </div>

    <div id="winnerBox">
      <div id="winnerName"></div>
      <div id="prizeName"></div>
      <div class="small" id="timeInfo"></div>
    </div>

    <div id="finalList">
      <button id="showListBtn">ğŸ‰ ã“ã‚Œã¾ã§ã®å½“é¸çµæœã‚’è¡¨ç¤º</button>
      <div id="listArea"></div>
      <div style="margin-top:10px;">
        <button id="downloadPdfBtn">PDFã§ä¿å­˜</button>
      </div>
    </div>
  </div>

  <audio id="bgm" src="bgm.mp3" preload="auto"></audio>

  <!-- confetti.js ã‚’CDNã‹ã‚‰èª­ã¿è¾¼ã¿ -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

  <script>
    // === è¨­å®šï¼šã“ã“ã«GASã®Webã‚¢ãƒ—ãƒªURLã‚’å…¥ã‚Œã‚‹ ===
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzBKU2b5vb-3Y4Os2SeDOYY7zJ_98GiRm78K8O3wJy5kfraZGZZZo6stRkgWfowZFAD/exec; // â† ã“ã“ã‚’æ›¸ãæ›ãˆã¦ãã ã•ã„

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒQRã§æ¥ãŸéš›ã«ã¯URLã« ?pid=P00X ãŒä»˜ã„ã¦ã„ã‚‹æƒ³å®š
    function getQueryParam(name){
      const url = new URL(location.href);
      return url.searchParams.get(name);
    }

    const pid = getQueryParam('pid'); // P001ãªã©
    const drawBtn = document.getElementById('drawBtn');
    const winnerBox = document.getElementById('winnerBox');
    const winnerName = document.getElementById('winnerName');
    const prizeName = document.getElementById('prizeName');
    const timeInfo = document.getElementById('timeInfo');
    const remainingText = document.getElementById('remainingText');
    const currentText = document.getElementById('currentText');
    const maxText = document.getElementById('maxText');
    const finalList = document.getElementById('finalList');
    const showListBtn = document.getElementById('showListBtn');
    const listArea = document.getElementById('listArea');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const bgm = document.getElementById('bgm');

    // confetti setup
    const confettiCanvas = document.getElementById('confetti-canvas');
    const myConfetti = confetti.create(confettiCanvas, { resize: true });

    // åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—
    async function fetchStatus(){
      try {
        const res = await fetch(`${GAS_URL}?action=status`);
        const j = await res.json();
        if(j.result === 'ok'){
          remainingText.textContent = 'æ®‹ã‚Š: ' + j.remaining;
          currentText.textContent = j.currentWinners;
          maxText.textContent = j.maxWinners;
          if(j.remaining === 0){
            // limit reached
            showFinalControls();
          }
        }
      } catch(e){ console.error(e); }
    }

    function showFinalControls(){
      // æŠ½é¸ä¸Šé™ã«é”ã£ã¦ã„ã‚‹æ™‚ã¯ finalList ã‚’ç›®ç«‹ãŸã›ã‚‹
      finalList.style.display = 'block';
      drawBtn.disabled = true;
      drawBtn.textContent = 'æŠ½é¸ã¯çµ‚äº†ã—ã¾ã—ãŸ';
    }

    // æŠ½é¸å®Ÿè¡Œ
    async function doDraw(){
      if(!pid){
        alert('ã‚¨ãƒ©ãƒ¼ï¼špidãŒURLã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚QRãƒªãƒ³ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      drawBtn.disabled = true;
      drawBtn.textContent = 'æŠ½é¸ä¸­...';

      try {
        const res = await fetch(`${GAS_URL}?pid=${encodeURIComponent(pid)}`);
        const j = await res.json();

        if(j.result === 'ok'){
          // å†ç”Ÿï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆå†…ãªã®ã§è‡ªå‹•å†ç”Ÿãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œãªã„ï¼‰
          try { await bgm.play(); } catch(e){ console.warn('BGMå†ç”Ÿã‚¨ãƒ©ãƒ¼', e); }
          // ç´™å¹é›ª
          myConfetti({
            particleCount: 120,
            spread: 80,
            origin: { y: 0.6 }
          });
          winnerBox.style.display = 'block';
          winnerName.textContent = (j.name && j.name !== '') ? j.name : 'åŒ¿å';
          prizeName.textContent = 'ğŸ ' + j.prize;
          timeInfo.textContent = 'ã‚ãªãŸã¯ ' + j.currentWinners + ' äººç›®ã®å½“é¸è€…ã§ã™';
          remainingText.textContent = 'æ®‹ã‚Š: ' + j.remaining;
          currentText.textContent = j.currentWinners;
          maxText.textContent = j.maxWinners;
          // hide button area
          document.getElementById('actionArea').style.display = 'none';

          // ã‚‚ã—ä¸Šé™ã«é”ã—ãŸã‚‰ finalList ã‚’è¡¨ç¤ºï¼ˆæœ€å¾Œã®å½“é¸ã®ãƒšãƒ¼ã‚¸ï¼‰
          if(j.remaining === 0){
            finalList.style.display = 'block';
            // è¡¨ç¤ºã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§ï¼ˆãƒœã‚¿ãƒ³ã§è¡¨ç¤ºï¼‰
          }
        } else if(j.result === 'limit_reached'){
          alert('æŠ½é¸ä¸Šé™ã«é”ã—ã¦ã„ã¾ã™ã€‚');
          showFinalControls();
        } else if(j.result === 'already_won'){
          winnerBox.style.display = 'block';
          winnerName.textContent = (j.name && j.name !== '') ? j.name : 'åŒ¿å';
          prizeName.textContent = 'ï¼ˆæ—¢ã«å½“é¸æ¸ˆã¿ï¼‰ ' + (j.prize || '');
          document.getElementById('actionArea').style.display = 'none';
        } else {
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (j.message||JSON.stringify(j)));
          drawBtn.disabled = false;
          drawBtn.textContent = 'æŠ½é¸ã™ã‚‹';
        }
      } catch(err){
        console.error(err);
        alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        drawBtn.disabled = false;
        drawBtn.textContent = 'æŠ½é¸ã™ã‚‹';
      }
    }

    // å½“é¸è€…ä¸€è¦§ã‚’å–å¾—ã—ã¦è¡¨ç¤º
    async function showWinnersList(){
      try {
        const res = await fetch(`${GAS_URL}?action=list`);
        const j = await res.json();
        if(j.result === 'ok'){
          const winners = j.winners;
          if(winners.length === 0){
            listArea.innerHTML = '<p class="small">ã¾ã å½“é¸è€…ã¯ã„ã¾ã›ã‚“ã€‚</p>';
            return;
          }
          var html = '<table><thead><tr><th>No</th><th>ID</th><th>æ°å</th><th>æ™¯å“</th><th>å½“é¸æ—¥æ™‚</th></tr></thead><tbody>';
          for(let i=0;i<winners.length;i++){
            const w = winners[i];
            html += `<tr><td>${i+1}</td><td>${w.id}</td><td>${w.name||'åŒ¿å'}</td><td>${w.prize}</td><td>${w.time||''}</td></tr>`;
          }
          html += '</tbody></table>';
          listArea.innerHTML = html;
        }
      } catch(e){ console.error(e); alert('ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼'); }
    }

    // PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function downloadPdf(){
      // ç›´æ¥GASã®PDFå‡ºåŠ›ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’é–‹ãã¨PDFãŒè¿”ã‚‹è¨­è¨ˆ
      window.open(`${GAS_URL}?action=pdf`, '_blank');
    }

    // åˆæœŸåŒ–
    (function(){
      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—ã—ã¦è¡¨ç¤º
      fetchStatus();

      // æŠ½é¸ãƒœã‚¿ãƒ³ã®æŒ™å‹•
      drawBtn.addEventListener('click', function(){
        doDraw();
      });

      // æœ€çµ‚ãƒªã‚¹ãƒˆé–¢é€£
      showListBtn.addEventListener('click', showWinnersList);
      downloadPdfBtn.addEventListener('click', downloadPdf);

      // ã‚‚ã— pid ãŒç„¡ã„å ´åˆã¯è­¦å‘Šè¡¨ç¤ºï¼ˆç®¡ç†è€…ãŒç›´æ¥æ“ä½œã™ã‚‹å ´åˆã‚‚ã‚ã‚‹ãŸã‚åˆ¶é™ã¯ã—ãªã„ï¼‰
      if(!pid){
        // ä»»æ„ï¼šæŠ½é¸ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹ã«ã—ã¦ãŠãï¼ˆç®¡ç†è€…ç”¨ï¼‰
        console.warn('pidãŒã‚ã‚Šã¾ã›ã‚“ã€‚QRãƒªãƒ³ã‚¯ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€URLã« ?pid=P001 ã®ã‚ˆã†ã«ä»˜ã‘ã¦ãã ã•ã„ã€‚');
      }
    })();
  </script>
</body>
</html>
